name: Run Automation Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        suite:
          - root/tests/test_login.py
          - root/tests/test_products.py


    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Chrome
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
         

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r requirements.txt
          pip3 install allure-pytest

      - name: Run tests with pytest
        run: |
          pytest -v ${{ matrix.suite }} --alluredir=allure-results --maxfail=1 --disable-warnings -q | tee pytest-output.txt
          echo "${PIPESTATUS[0]}" > exit-code.txt
        continue-on-error: true

      - name: Set safe artifact name
        id: sanitize
        run: echo "safe_name=$(echo '${{ matrix.suite }}' | tr '/' '_' | tr '.' '_')" >> $GITHUB_OUTPUT

      - name: Upload Allure Results
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ steps.sanitize.outputs.safe_name }}
          path: allure-results

      - name: Fail the job if pytest failed
        run: |
          exit_code=$(cat exit-code.txt)
          exit $exit_code
        if: always()

  generate-report:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    outputs:
      report-dir: allure-report

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install GitHub CLI and unzip
        run: sudo apt-get update && sudo apt-get install -y gh jq unzip

      - name: Download and merge allure results
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p allure-results
          artifacts=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq '.artifacts[].name' | grep '^allure-results-')

          echo "Merging artifacts:"
          echo "$artifacts"

          for name in $artifacts; do
            url=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts --jq ".artifacts[] | select(.name==\"$name\") | .archive_download_url")
            curl -sL -H "Authorization: token $GH_TOKEN" "$url" -o "$name.zip"
            unzip -q "$name.zip" -d temp
            cp -r temp/* allure-results/
            rm -rf temp "$name.zip"
          done

      - name: Download Allure CLI
        run: |
          wget https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -zxvf allure-2.27.0.tgz
          sudo mv allure-2.27.0 /opt/allure
          sudo ln -s /opt/allure/bin/allure /usr/bin/allure

      - name: Generate Allure report
        run: |
          allure generate allure-results -o allure-report --clean

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: allure-report

  deploy-report:
    runs-on: ubuntu-latest
    needs: generate-report
    if: always()
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4


# name: Run Automation Tests + Allure Report

# on:
#   push:
#     branches: [ main ]
#   pull_request:
#     branches: [ main ]

# permissions:
#   contents: read
#   pages: write
#   id-token: write

# jobs:
#   test:
#     runs-on: ubuntu-latest
#     strategy:
#       fail-fast: false
#       matrix:
#         suite:
#           - root/tests/test_login.py
#           - root/tests/test_products.py

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4  # Cập nhật lên v4 cho ổn định

#       - name: Install Chrome
#         run: |
#           wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
#           echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
#           sudo apt-get update
#           sudo apt-get install -y google-chrome-stable

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.13"

#       - name: Install dependencies
#         run: |
#           python -m pip install --upgrade pip
#           pip install -r requirements.txt
#           pip install allure-pytest

#       - name: Run tests
#         run: |
#           pytest ${{ matrix.suite }} \
#             --alluredir=allure-results \
#             --clean-alluredir \
#             -v

#       # Fix lỗi: Dùng bash để sanitize tên (thay thế / và . bằng _)
#       - name: Set safe artifact name
#         id: sanitize
#         run: echo "safe_name=$(echo '${{ matrix.suite }}' | tr '/' '_' | tr '.' '_')" >> $GITHUB_OUTPUT

#       # Upload chỉ khi có file (tránh rỗng)
#       - name: Upload Allure results
#         if: always()
#         uses: actions/upload-artifact@v4
#         with:
#           name: allure-results-${{ steps.sanitize.outputs.safe_name }}
#           path: allure-results/
#           if-no-files-found: ignore

#   generate-report:
#     runs-on: ubuntu-latest
#     needs: test
#     if: always()  # Chạy kể cả test fail
#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # Fix lỗi: Dùng download-artifact thay vì gh CLI (đơn giản hơn, không cần token)
#       - name: Download Allure artifacts & merge
#         uses: actions/download-artifact@v4
#         with:
#           pattern: allure-results-*
#           merge-multiple: true
#           path: allure-results

#       # Debug để check file (tùy chọn, có thể xóa sau)
#       - name: Debug - list files
#         run: |
#           echo "=== Allure results content ==="
#           ls -la allure-results/ || echo "Empty or missing"

#       # Cài Allure CLI (bản mới hơn, nhanh)
#       - name: Install Allure CLI
#         run: |
#           curl -o allure.tgz -Ls https://github.com/allure-framework/allure2/releases/download/2.29.0/allure-2.29.0.tgz
#           tar -zxvf allure.tgz
#           sudo mv allure-2.29.0 /opt/allure
#           echo "/opt/allure/bin" >> $GITHUB_PATH

#       - name: Generate Allure report
#         run: |
#           allure generate allure-results --clean -o allure-report

#       - name: Upload Pages artifact
#         uses: actions/upload-pages-artifact@v3
#         with:
#           path: allure-report

#   deploy-report:
#     runs-on: ubuntu-latest
#     needs: generate-report
#     if: always()
#     environment:
#       name: github-pages
#       url: ${{ steps.deploy.outputs.page_url }}

#     steps:
#       - name: Deploy to GitHub Pages
#         id: deploy
#         uses: actions/deploy-pages@v4